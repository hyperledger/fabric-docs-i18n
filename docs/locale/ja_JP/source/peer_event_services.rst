Peer channel-based event services
=================================

General overview
----------------

Fabricの過去バージョンにおいて、ピアイベントサービスはイベントハブとして知られていました。このサービスは、チャネルに関わらず新しいブロックがピアの台帳に追加された際にイベントを送信し、イベンティングピアを稼働させている組織（i.e., イベントを受信する組織）のメンバのみがアクセスすることが出来ます。

v1.1から、イベントを提供する新しいサービスがあります。これらのサービスは、各チャネルをベースにしたイベント提供とは全く異なる設計となっています。これは、ピアのデータへのきめ細かい制御を実現するために、ピアではなくチャネルのレベルでイベントの登録が実施されます。イベントを受信するリクエストは、（チャネル設定で定義された）ピアの組織外のアイデンティティを元に受け付けられます。これはより良い信頼性と（接続上の課題やピアが既にネットワークに参加しているかに関係なく）届かなかったイベントを受信する方法も提供します。

Available services
------------------

* ``Deliver``

このサービスは、台帳にコミットされた全てのブロックを送信します。もしチェーンコードによって設定されたイベントであれば、ブロックの ``ChaincodeActionPayload`` 内に格納されています。

* ``DeliverWithPrivateData``

このサービスは、 ``Deliver`` サービスと同じデータを送信し、アクセス可能なことをクライアントの組織で認証したコレクションのプライベートデータを追加で含めることが出来ます。

* ``DeliverFiltered``

このサービスは、台帳にコミットされたブロックに関する情報の最小セットである "フィルターされた" ブロックを送信します。ピアの所有者が外部のクライアントから受信したトランザクションやトランザクションの状態に関する情報をネットワークで使用することを目的としています。もしチェーンコードによって設定されたイベントであれば、フィルタードブロックの ``FilteredChaincodeAction`` に格納されます。
.. 注釈:: チェーンコードイベントのペイロードはフィルタードブロックに含まれません。

How to register for events
--------------------------

イベントの登録は、スタートとストップの位置、依頼の挙動（レディでなければレディもしくはフェイルになるブロック）を含むピアへの配信依頼情報メッセージを含むエンベロープを送信することで完了します。ヘルパー変数として ``SeekOldest`` と ``SeekNewest`` があり、台帳の一番古い（i.e. 最初の）ブロックもしくは最新の（i.e. 最後の）ブロックを示します。無制限にサービスを送信するために、 ``SeekInfo`` メッセージを ``MAXINT64`` のストップ位置に含む必要があります。
.. 注釈:: もし相互TLSがピアで有効になっていた場合、TLS証明書のハッシュ値をエンベロープのチャネルヘッダーに設定しなければなりません。

デフォルトでイベントサービスは、イベントをリクエストするクライアントを認証するかどうかを決めるためにチャネルリーダポリシーを使用します。

Overview of deliver response messages
-------------------------------------

イベントサービスは、 ``DeliverResponse`` メッセージを送り返します。

各メッセージは以下を含みます:

 * ステータス -- HTTPステータスコード。 各サービスは、エラーが発生した場合、適切なエラーコードを返します。一方で、 ``SeekInfo`` メッセージによってリクエストされた全情報の送信をサービスが完了すると一度だけ ``200 - SUCCESS`` を返します。
 * ブロック -- ``Deliver`` サービスによってだけ返します。
 * ブロックとプライベートデータ -- ``DeliverWithPrivateData`` サービスによってだけ返します。
 * フィルタードブロック -- ``DeliverFiltered`` サービスによってだけ返します。

フィルタードブロックは以下を含みます：

 * チャネルID
 * 番号（i.e. ブロック番号）
 * フィルタードトランザクションの配列
 * トランザクションID

   * タイプ (e.g. ``ENDORSER_TRANSACTION``, ``CONFIG``).
   * トランザクション検証コード

 * フィルタードトランザクションのアクション
     * フィルタードチェーンコードのアクションの配列
        * 記載されたペイロードとトランザクションに対するチェーンコードイベント

SDK event documentation
-----------------------

イベントサービスに関しての詳細は、 `SDK documentation. <https://hyperledger.github.io/fabric-sdk-node/{BRANCH}/tutorial-channel-events.html>`_ を参照して下さい。

.. Licensed under Creative Commons Attribution 4.0 International License
    https://creativecommons.org/licenses/by/4.0/
