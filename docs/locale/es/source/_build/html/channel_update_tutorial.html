

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Adding an Org to a Channel &mdash; hyperledger-fabricdocs master documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="&lt;no title&gt;" href="config_update.html" />
    <link rel="prev" title="Using CouchDB" href="couchdb_tutorial.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          


          
            <a href="index.html" class="icon icon-home"> hyperledger-fabricdocs
          

          
          </a>

          
            
            
              <div class="version">
                master
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          

<br><img style="background-color: #fff; height: unset; width: unset;" alt="Hyperledger Fabric" src=_images/hyperledger_fabric_logo_color.png />
<br>
<a href="https://github.com/hyperledger/fabric"><img style="padding: 0px; margin: auto auto auto auto;" alt="GitHub" src="_static/images/github_button.png"/></a>
&nbsp;<a href="https://stackoverflow.com/questions/tagged/hyperledger-fabric"><img style="padding: 0px; margin: auto auto auto auto;" alt="StackOverflow" src="_static/images/stackoverflow_button.png"/></a>
&nbsp;<a href="https://chat.hyperledger.org"><img style="padding: 0px; margin: auto auto auto auto;" alt="Rocket Chat" src="_static/images/rocketchat_button.png"/></a>
&nbsp;<a href="https://www.youtube.com/playlist?list=PL0MZ85B_96CH7wvtrRzV7SvtRY0sI0DEg"><img style="padding: 0px; margin: auto auto auto auto;" alt="Youtube Channel" src="_static/images/youtube_button.png"/></a>

        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="whatsnew.html">What’s new in Hyperledger Fabric v2.x</a></li>
<li class="toctree-l1"><a class="reference internal" href="whatsnew.html#release-notes">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="key_concepts.html">Principais Conceitos</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="developapps/developing_applications.html">Developing Applications</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="test_network.html">##### Generate certificates using cryptogen tool #########</a></li>
<li class="toctree-l2"><a class="reference internal" href="test_network.html#create-org1-identities">############ Create Org1 Identities ######################</a></li>
<li class="toctree-l2"><a class="reference internal" href="deploy_chaincode.html">}</a></li>
<li class="toctree-l2"><a class="reference internal" href="deploy_chaincode.html#id12">}</a></li>
<li class="toctree-l2"><a class="reference internal" href="deploy_chaincode.html#id21">}</a></li>
<li class="toctree-l2"><a class="reference internal" href="deploy_chaincode.html#id24">}</a></li>
<li class="toctree-l2"><a class="reference internal" href="deploy_chaincode.html#id43">}</a></li>
<li class="toctree-l2"><a class="reference internal" href="write_first_app.html">Writing Your First Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial/commercial_paper.html">}</a></li>
<li class="toctree-l2"><a class="reference internal" href="private_data_tutorial.html">Using Private Data in Fabric</a></li>
<li class="toctree-l2"><a class="reference internal" href="couchdb_tutorial.html">Using CouchDB</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Adding an Org to a Channel</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#setup-the-environment">Setup the Environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bring-org3-into-the-channel-with-the-script">Bring Org3 into the Channel with the Script</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bring-org3-into-the-channel-manually">Bring Org3 into the Channel Manually</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generate-the-org3-crypto-material">Generate the Org3 Crypto Material</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bring-up-org3-components">Bring up Org3 components</a></li>
<li class="toctree-l3"><a class="reference internal" href="#prepare-the-cli-environment">Prepare the CLI Environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fetch-the-configuration">Fetch the Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#convert-the-configuration-to-json-and-trim-it-down">Convert the Configuration to JSON and Trim It Down</a></li>
<li class="toctree-l3"><a class="reference internal" href="#add-the-org3-crypto-material">Add the Org3 Crypto Material</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sign-and-submit-the-config-update">Sign and Submit the Config Update</a></li>
<li class="toctree-l3"><a class="reference internal" href="#join-org3-to-the-channel">Join Org3 to the Channel</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuring-leader-election">Configuring Leader Election</a></li>
<li class="toctree-l3"><a class="reference internal" href="#install-define-and-invoke-chaincode">Install, define, and invoke chaincode</a></li>
<li class="toctree-l3"><a class="reference internal" href="#conclusion">Conclusion</a></li>
<li class="toctree-l3"><a class="reference internal" href="#updating-the-channel-config-to-include-an-org3-anchor-peer-optional">Updating the Channel Config to include an Org3 Anchor Peer (Optional)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="chaincode4ade.html">Chaincode for Developers</a></li>
<li class="toctree-l2"><a class="reference internal" href="build_network.html">Building Your First Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="videos.html">Videos</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="deployment_guide_overview.html">Deploying a production network</a></li>
<li class="toctree-l1"><a class="reference internal" href="ops_guide.html">Operations Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="upgrade.html">Upgrading to the latest release</a></li>
<li class="toctree-l1"><a class="reference internal" href="command_ref.html">Commands Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="Fabric-FAQ.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="CONTRIBUTING.html">Contributions Welcome!</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="releases.html">Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="questions.html">Still Have Questions?</a></li>
<li class="toctree-l1"><a class="reference internal" href="status.html">Status</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">hyperledger-fabricdocs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="tutorials.html">Tutorials</a> &raquo;</li>
        
      <li>Adding an Org to a Channel</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/channel_update_tutorial.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="adding-an-org-to-a-channel">
<h1>Adding an Org to a Channel<a class="headerlink" href="#adding-an-org-to-a-channel" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Ensure that you have downloaded the appropriate images and binaries
as outlined in <a class="reference internal" href="install.html"><span class="doc">Install Samples, Binaries, and Docker Images</span></a> and <a class="reference internal" href="prereqs.html"><span class="doc">Prerequisites</span></a> that conform to the
version of this documentation (which can be found at the bottom of the
table of contents to the left).</p>
</div>
<p>This tutorial extends the Fabric test network by adding a new organization
– Org3 – to an application channel.</p>
<p>While we will focus on adding a new organization to the channel, you can use a
similar process to make other channel configuration updates (updating modification
policies or altering batch size, for example). To learn more about the process
and possibilities of channel config updates in general, check out <a class="reference internal" href="config_update.html"><span class="doc">&lt;no title&gt;</span></a>).
It’s also worth noting that channel configuration updates like the one
demonstrated here will usually be the responsibility of an organization admin
(rather than a chaincode or application developer).</p>
<div class="section" id="setup-the-environment">
<h2>Setup the Environment<a class="headerlink" href="#setup-the-environment" title="Permalink to this headline">¶</a></h2>
<p>We will be operating from the root of the <code class="docutils literal notranslate"><span class="pre">test-network</span></code> subdirectory within
your local clone of <code class="docutils literal notranslate"><span class="pre">fabric-samples</span></code>. Change into that directory now.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> fabric-samples/test-network
</pre></div>
</div>
<p>First, use the <code class="docutils literal notranslate"><span class="pre">network.sh</span></code> script to tidy up. This command will kill any active
or stale Docker containers and remove previously generated artifacts. It is by no
means <strong>necessary</strong> to bring down a Fabric network in order to perform channel
configuration update tasks. However, for the sake of this tutorial, we want to operate
from a known initial state. Therefore let’s run the following command to clean up any
previous environments:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./network.sh down
</pre></div>
</div>
<p>You can now use the script to bring up the test network with one channel named
<code class="docutils literal notranslate"><span class="pre">mychannel</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./network.sh up createChannel
</pre></div>
</div>
<p>If the command was successful, you can see the following message printed in your
logs:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">=========</span> Channel successfully <span class="nv">joined</span> <span class="o">===========</span>
</pre></div>
</div>
<p>Now that you have a clean version of the test network running on your machine, we
can start the process of adding a new org to the channel we created. First, we are
going use a script to add Org3 to the channel to confirm that the process works.
Then, we will go through the step by step process of adding Org3 by updating the
channel configuration.</p>
</div>
<div class="section" id="bring-org3-into-the-channel-with-the-script">
<h2>Bring Org3 into the Channel with the Script<a class="headerlink" href="#bring-org3-into-the-channel-with-the-script" title="Permalink to this headline">¶</a></h2>
<p>You should be in the <code class="docutils literal notranslate"><span class="pre">test-network</span></code> directory. To use the script, simply issue
the following commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> addOrg3
./addOrg3.sh up
</pre></div>
</div>
<p>The output here is well worth reading. You’ll see the Org3 crypto material being
generated, the Org3 organization definition being created, and then the channel
configuration being updated, signed, and then submitted to the channel.</p>
<p>If everything goes well, you’ll get this message:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">=========</span> Finished adding Org3 to your <span class="nb">test</span> network! <span class="o">=========</span>
</pre></div>
</div>
<p>Now that we have confirmed we can add Org3 to our channel, we can go through the
steps to update the channel configuration that the script completed behind the
scenes.</p>
</div>
<div class="section" id="bring-org3-into-the-channel-manually">
<h2>Bring Org3 into the Channel Manually<a class="headerlink" href="#bring-org3-into-the-channel-manually" title="Permalink to this headline">¶</a></h2>
<p>If you just used the <code class="docutils literal notranslate"><span class="pre">addOrg3.sh</span></code> script, you’ll need to bring your network down.
The following command will bring down all running components and remove the crypto
material for all organizations:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./addOrg3.sh down
</pre></div>
</div>
<p>After the network is brought down, bring it back up again:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> ..
./network.sh up createChannel
</pre></div>
</div>
<p>This will bring your network back to the same state it was in before you executed
the <code class="docutils literal notranslate"><span class="pre">addOrg3.sh</span></code> script.</p>
<p>Now we’re ready to add Org3 to the channel manually. As a first step, we’ll need
to generate Org3’s crypto material.</p>
</div>
<div class="section" id="generate-the-org3-crypto-material">
<h2>Generate the Org3 Crypto Material<a class="headerlink" href="#generate-the-org3-crypto-material" title="Permalink to this headline">¶</a></h2>
<p>In another terminal, change into the <code class="docutils literal notranslate"><span class="pre">addOrg3</span></code> subdirectory from
<code class="docutils literal notranslate"><span class="pre">test-network</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> addOrg3
</pre></div>
</div>
<p>First, we are going to create the certificates and keys for the Org3 peer, along
with an application and admin user. Because we are updating an example channel,
we are going to use the cryptogen tool instead of using a Certificate Authority.
The following command uses cryptogen  to read the <code class="docutils literal notranslate"><span class="pre">org3-crypto.yaml</span></code> file
and generate the Org3 crypto material in a new <code class="docutils literal notranslate"><span class="pre">org3.example.com</span></code> folder:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>../../bin/cryptogen generate --config<span class="o">=</span>org3-crypto.yaml --output<span class="o">=</span><span class="s2">&quot;../organizations&quot;</span>
</pre></div>
</div>
<p>You can find the generated Org3 crypto material alongside the certificates and
keys for Org1 and Org2 in the <code class="docutils literal notranslate"><span class="pre">test-network/organizations/peerOrganizations</span></code>
directory.</p>
<p>Once we have created the Org3 crypto material, we can use the configtxgen
tool to print out the Org3 organization definition. We will preface the command
by telling the tool to look in the current directory for the <code class="docutils literal notranslate"><span class="pre">configtx.yaml</span></code>
file that it needs to ingest.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">FABRIC_CFG_PATH</span><span class="o">=</span><span class="nv">$PWD</span>
../../bin/configtxgen -printOrg Org3MSP &gt; ../organizations/peerOrganizations/org3.example.com/org3.json
</pre></div>
</div>
<p>The above command creates a JSON file – <code class="docutils literal notranslate"><span class="pre">org3.json</span></code> – and writes it to the
<code class="docutils literal notranslate"><span class="pre">test-network/organizations/peerOrganizations/org3.example.com</span></code> folder. The
organization definition contains the policy definitions for Org3, as well as three
important certificates encoded in base64 format:</p>
<blockquote>
<div><ul class="simple">
<li><p>a CA root cert, used to establish the organizations root of trust</p></li>
<li><p>a TLS root cert, used by the gossip protocol to identify Org3 for block dissemination and service discovery</p></li>
<li><p>The admin user certificate (which will be needed to act as the admin of Org3 later on)</p></li>
</ul>
</div></blockquote>
<p>We will add Org3 to the channel by appending this organization definition to
the channel configuration.</p>
</div>
<div class="section" id="bring-up-org3-components">
<h2>Bring up Org3 components<a class="headerlink" href="#bring-up-org3-components" title="Permalink to this headline">¶</a></h2>
<p>After we have created the Org3 certificate material, we can now bring up the
Org3 peer. From the <code class="docutils literal notranslate"><span class="pre">addOrg3</span></code> directory, issue the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker-compose -f docker/docker-compose-org3.yaml up -d
</pre></div>
</div>
<p>If the command is successful, you will see the the creation of the Org3 peer and
an instance of the Fabric tools container named Org3CLI:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Creating peer0.org3.example.com ... <span class="k">done</span>
Creating Org3cli                ... <span class="k">done</span>
</pre></div>
</div>
<p>This Docker Compose file has been configured to bridge across our initial network,
so that the Org3 peer and Org3CLI resolve with the existing peers and ordering
node of the test network. We will use the Org3CLI container to communicate with
the network and issue the peer commands that will add Org3 to the channel.</p>
</div>
<div class="section" id="prepare-the-cli-environment">
<h2>Prepare the CLI Environment<a class="headerlink" href="#prepare-the-cli-environment" title="Permalink to this headline">¶</a></h2>
<p>The update process makes use of the configuration translator tool – configtxlator.
This tool provides a stateless REST API independent of the SDK. Additionally it
provides a CLI tool that can be used to simplify configuration tasks in Fabric
networks. The tool allows for the easy conversion between different equivalent
data representations/formats (in this case, between protobufs and JSON).
Additionally, the tool can compute a configuration update transaction based on
the differences between two channel configurations.</p>
<p>Use the following command to exec into the Org3CLI container:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker <span class="nb">exec</span> -it Org3cli bash
</pre></div>
</div>
<p>This container has been mounted with the <code class="docutils literal notranslate"><span class="pre">organizations</span></code> folder, giving us
access to the crypto material and TLS certificates for all organizations and the
Orderer Org. We can use environment variables to operate the Org3CLI container
as the admin of Org1, Org2, or Org3. First, we need to set the environment
variables for the orderer TLS certificate and the channel name:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">ORDERER_CA</span><span class="o">=</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem
<span class="nb">export</span> <span class="nv">CHANNEL_NAME</span><span class="o">=</span>mychannel
</pre></div>
</div>
<p>Check to make sure the variables have been properly set:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="nv">$ORDERER_CA</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="nv">$CHANNEL_NAME</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If for any reason you need to restart the Org3CLI container, you will also need to
re-export the two environment variables – <code class="docutils literal notranslate"><span class="pre">ORDERER_CA</span></code> and <code class="docutils literal notranslate"><span class="pre">CHANNEL_NAME</span></code>.</p>
</div>
</div>
<div class="section" id="fetch-the-configuration">
<h2>Fetch the Configuration<a class="headerlink" href="#fetch-the-configuration" title="Permalink to this headline">¶</a></h2>
<p>Now we have the Org3CLI container with our two key environment variables – <code class="docutils literal notranslate"><span class="pre">ORDERER_CA</span></code>
and <code class="docutils literal notranslate"><span class="pre">CHANNEL_NAME</span></code> exported.  Let’s go fetch the most recent config block for the
channel – <code class="docutils literal notranslate"><span class="pre">mychannel</span></code>.</p>
<p>The reason why we have to pull the latest version of the config is because channel
config elements are versioned. Versioning is important for several reasons. It prevents
config changes from being repeated or replayed (for instance, reverting to a channel config
with old CRLs would represent a security risk). Also it helps ensure concurrency (if you
want to remove an Org from your channel, for example, after a new Org has been added,
versioning will help prevent you from removing both Orgs, instead of just the Org you want
to remove).</p>
<p>Because Org3 is not yet a member of the channel, we need to operate as the admin
of another organization to fetch the channel config. Because Org1 is a member of the channel, the
Org1 admin has permission to fetch the channel config from the ordering service.
Issue the following commands to operate as the Org1 admin.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># you can issue all of these commands at once</span>

<span class="nb">export</span> <span class="nv">CORE_PEER_LOCALMSPID</span><span class="o">=</span><span class="s2">&quot;Org1MSP&quot;</span>
<span class="nb">export</span> <span class="nv">CORE_PEER_TLS_ROOTCERT_FILE</span><span class="o">=</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt
<span class="nb">export</span> <span class="nv">CORE_PEER_MSPCONFIGPATH</span><span class="o">=</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/organizations/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp
<span class="nb">export</span> <span class="nv">CORE_PEER_ADDRESS</span><span class="o">=</span>peer0.org1.example.com:7051
</pre></div>
</div>
<p>We can now issue the command to fetch the latest config block:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer channel fetch config config_block.pb -o orderer.example.com:7050 -c <span class="nv">$CHANNEL_NAME</span> --tls --cafile <span class="nv">$ORDERER_CA</span>
</pre></div>
</div>
<p>This command saves the binary protobuf channel configuration block to
<code class="docutils literal notranslate"><span class="pre">config_block.pb</span></code>. Note that the choice of name and file extension is arbitrary.
However, following a convention which identifies both the type of object being
represented and its encoding (protobuf or JSON) is recommended.</p>
<p>When you issued the <code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span> <span class="pre">fetch</span></code> command, the following output is
displayed in your logs:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">2017</span>-11-07 <span class="m">17</span>:17:57.383 UTC <span class="o">[</span>channelCmd<span class="o">]</span> readBlock -&gt; DEBU <span class="m">011</span> Received block: <span class="m">2</span>
</pre></div>
</div>
<p>This is telling us that the most recent configuration block for <code class="docutils literal notranslate"><span class="pre">mychannel</span></code> is
actually block 2, <strong>NOT</strong> the genesis block. By default, the <code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span> <span class="pre">fetch</span> <span class="pre">config</span></code>
command returns the most <strong>recent</strong> configuration block for the targeted channel, which
in this case is the third block. This is because the test network script, <code class="docutils literal notranslate"><span class="pre">network.sh</span></code>, defined anchor
peers for our two organizations – <code class="docutils literal notranslate"><span class="pre">Org1</span></code> and <code class="docutils literal notranslate"><span class="pre">Org2</span></code> – in two separate channel update
transactions. As a result, we have the following configuration sequence:</p>
<blockquote>
<div><ul class="simple">
<li><p>block 0: genesis block</p></li>
<li><p>block 1: Org1 anchor peer update</p></li>
<li><p>block 2: Org2 anchor peer update</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="convert-the-configuration-to-json-and-trim-it-down">
<h2>Convert the Configuration to JSON and Trim It Down<a class="headerlink" href="#convert-the-configuration-to-json-and-trim-it-down" title="Permalink to this headline">¶</a></h2>
<p>Now we will make use of the <code class="docutils literal notranslate"><span class="pre">configtxlator</span></code> tool to decode this channel
configuration block into JSON format (which can be read and modified by humans).
We also must strip away all of the headers, metadata, creator signatures, and
so on that are irrelevant to the change we want to make. We accomplish this by
means of the <code class="docutils literal notranslate"><span class="pre">jq</span></code> tool:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator proto_decode --input config_block.pb --type common.Block <span class="p">|</span> jq .data.data<span class="o">[</span><span class="m">0</span><span class="o">]</span>.payload.data.config &gt; config.json
</pre></div>
</div>
<p>This command leaves us with a trimmed down JSON object – <code class="docutils literal notranslate"><span class="pre">config.json</span></code> – which
will serve as the baseline for our config update.</p>
<p>Take a moment to open this file inside your text editor of choice (or in your
browser). Even after you’re done with this tutorial, it will be worth studying it
as it reveals the underlying configuration structure and the other kind of channel
updates that can be made. We discuss them in more detail in <a class="reference internal" href="config_update.html"><span class="doc">&lt;no title&gt;</span></a>.</p>
</div>
<div class="section" id="add-the-org3-crypto-material">
<h2>Add the Org3 Crypto Material<a class="headerlink" href="#add-the-org3-crypto-material" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The steps you’ve taken up to this point will be nearly identical no matter
what kind of config update you’re trying to make. We’ve chosen to add an
org with this tutorial because it’s one of the most complex channel
configuration updates you can attempt.</p>
</div>
<p>We’ll use the <code class="docutils literal notranslate"><span class="pre">jq</span></code> tool once more to append the Org3 configuration definition
– <code class="docutils literal notranslate"><span class="pre">org3.json</span></code> – to the channel’s application groups field, and name the output
– <code class="docutils literal notranslate"><span class="pre">modified_config.json</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>jq -s <span class="s1">&#39;.[0] * {&quot;channel_group&quot;:{&quot;groups&quot;:{&quot;Application&quot;:{&quot;groups&quot;: {&quot;Org3MSP&quot;:.[1]}}}}}&#39;</span> config.json ./organizations/peerOrganizations/org3.example.com/org3.json &gt; modified_config.json
</pre></div>
</div>
<p>Now, within the Org3CLI container we have two JSON files of interest – <code class="docutils literal notranslate"><span class="pre">config.json</span></code>
and <code class="docutils literal notranslate"><span class="pre">modified_config.json</span></code>. The initial file contains only Org1 and Org2 material,
whereas the “modified” file contains all three Orgs. At this point it’s simply
a matter of re-encoding these two JSON files and calculating the delta.</p>
<p>First, translate <code class="docutils literal notranslate"><span class="pre">config.json</span></code> back into a protobuf called <code class="docutils literal notranslate"><span class="pre">config.pb</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator proto_encode --input config.json --type common.Config --output config.pb
</pre></div>
</div>
<p>Next, encode <code class="docutils literal notranslate"><span class="pre">modified_config.json</span></code> to <code class="docutils literal notranslate"><span class="pre">modified_config.pb</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator proto_encode --input modified_config.json --type common.Config --output modified_config.pb
</pre></div>
</div>
<p>Now use <code class="docutils literal notranslate"><span class="pre">configtxlator</span></code> to calculate the delta between these two config
protobufs. This command will output a new protobuf binary named <code class="docutils literal notranslate"><span class="pre">org3_update.pb</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator compute_update --channel_id <span class="nv">$CHANNEL_NAME</span> --original config.pb --updated modified_config.pb --output org3_update.pb
</pre></div>
</div>
<p>This new proto – <code class="docutils literal notranslate"><span class="pre">org3_update.pb</span></code> – contains the Org3 definitions and high
level pointers to the Org1 and Org2 material. We are able to forgo the extensive
MSP material and modification policy information for Org1 and Org2 because this
data is already present within the channel’s genesis block. As such, we only need
the delta between the two configurations.</p>
<p>Before submitting the channel update, we need to perform a few final steps. First,
let’s decode this object into editable JSON format and call it <code class="docutils literal notranslate"><span class="pre">org3_update.json</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator proto_decode --input org3_update.pb --type common.ConfigUpdate <span class="p">|</span> jq . &gt; org3_update.json
</pre></div>
</div>
<p>Now, we have a decoded update file – <code class="docutils literal notranslate"><span class="pre">org3_update.json</span></code> – that we need to wrap
in an envelope message. This step will give us back the header field that we stripped away
earlier. We’ll name this file <code class="docutils literal notranslate"><span class="pre">org3_update_in_envelope.json</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s1">&#39;{&quot;payload&quot;:{&quot;header&quot;:{&quot;channel_header&quot;:{&quot;channel_id&quot;:&quot;&#39;</span><span class="nv">$CHANNEL_NAME</span><span class="s1">&#39;&quot;, &quot;type&quot;:2}},&quot;data&quot;:{&quot;config_update&quot;:&#39;</span><span class="k">$(</span>cat org3_update.json<span class="k">)</span><span class="s1">&#39;}}}&#39;</span> <span class="p">|</span> jq . &gt; org3_update_in_envelope.json
</pre></div>
</div>
<p>Using our properly formed JSON – <code class="docutils literal notranslate"><span class="pre">org3_update_in_envelope.json</span></code> – we will
leverage the <code class="docutils literal notranslate"><span class="pre">configtxlator</span></code> tool one last time and convert it into the
fully fledged protobuf format that Fabric requires. We’ll name our final update
object <code class="docutils literal notranslate"><span class="pre">org3_update_in_envelope.pb</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator proto_encode --input org3_update_in_envelope.json --type common.Envelope --output org3_update_in_envelope.pb
</pre></div>
</div>
</div>
<div class="section" id="sign-and-submit-the-config-update">
<h2>Sign and Submit the Config Update<a class="headerlink" href="#sign-and-submit-the-config-update" title="Permalink to this headline">¶</a></h2>
<p>Almost done!</p>
<p>We now have a protobuf binary – <code class="docutils literal notranslate"><span class="pre">org3_update_in_envelope.pb</span></code> – within the
Org3CLI container. However, we need signatures from the requisite Admin users
before the config can be written to the ledger. The modification policy (mod_policy)
for our channel Application group is set to the default of “MAJORITY”, which means that
we need a majority of existing org admins to sign it. Because we have only two orgs –
Org1 and Org2 – and the majority of two is two, we need both of them to sign. Without
both signatures, the ordering service will reject the transaction for failing to
fulfill the policy.</p>
<p>First, let’s sign this update proto as Org1. Remember that we exported the
necessary environment variables to operate the Org3CLI container as the Org1 admin.
As a result, the following <code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span> <span class="pre">signconfigtx</span></code> command will sign the update as Org1.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer channel signconfigtx -f org3_update_in_envelope.pb
</pre></div>
</div>
<p>The final step is to switch the container’s identity to reflect the Org2 Admin
user. We do this by exporting four environment variables specific to the Org2 MSP.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Switching between organizations to sign a config transaction (or to do anything
else) is not reflective of a real-world Fabric operation. A single container
would never be mounted with an entire network’s crypto material. Rather, the
config update would need to be securely passed out-of-band to an Org2
Admin for inspection and approval.</p>
</div>
<p>Export the Org2 environment variables:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># you can issue all of these commands at once</span>

<span class="nb">export</span> <span class="nv">CORE_PEER_LOCALMSPID</span><span class="o">=</span><span class="s2">&quot;Org2MSP&quot;</span>
<span class="nb">export</span> <span class="nv">CORE_PEER_TLS_ROOTCERT_FILE</span><span class="o">=</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt
<span class="nb">export</span> <span class="nv">CORE_PEER_MSPCONFIGPATH</span><span class="o">=</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/organizations/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp
<span class="nb">export</span> <span class="nv">CORE_PEER_ADDRESS</span><span class="o">=</span>peer0.org2.example.com:9051
</pre></div>
</div>
<p>Lastly, we will issue the <code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span> <span class="pre">update</span></code> command. The Org2 Admin signature
will be attached to this call so there is no need to manually sign the protobuf a
second time:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The upcoming update call to the ordering service will undergo a series
of systematic signature and policy checks. As such you may find it
useful to stream and inspect the ordering node’s logs. You can issue a
<code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">logs</span> <span class="pre">-f</span> <span class="pre">orderer.example.com</span></code> command from a terminal outside
the Org3CLI container to display them.</p>
</div>
<p>Send the update call:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer channel update -f org3_update_in_envelope.pb -c <span class="nv">$CHANNEL_NAME</span> -o orderer.example.com:7050 --tls --cafile <span class="nv">$ORDERER_CA</span>
</pre></div>
</div>
<p>You should see a message similar to the following if your update has been submitted successfully:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">2020</span>-01-09 <span class="m">21</span>:30:45.791 UTC <span class="o">[</span>channelCmd<span class="o">]</span> update -&gt; INFO <span class="m">002</span> Successfully submitted channel update
</pre></div>
</div>
<p>The successful channel update call returns a new block – block 3 – to all of the
peers on the channel. If you remember, blocks 0-2 are the initial channel
configurations. Block 3 serves as the most recent channel configuration with
Org3 now defined on the channel.</p>
<p>You can inspect the logs for <code class="docutils literal notranslate"><span class="pre">peer0.org1.example.com</span></code> by navigating to a terminal
outside the Org3CLI container and issuing the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker logs -f peer0.org1.example.com
</pre></div>
</div>
</div>
<div class="section" id="join-org3-to-the-channel">
<h2>Join Org3 to the Channel<a class="headerlink" href="#join-org3-to-the-channel" title="Permalink to this headline">¶</a></h2>
<p>At this point, the channel configuration has been updated to include our new
organization – Org3 – meaning that peers attached to it can now join <code class="docutils literal notranslate"><span class="pre">mychannel</span></code>.</p>
<p>Inside the Org3CLI container, export the following environment variables to operate
as the Org3 Admin:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># you can issue all of these commands at once</span>

<span class="nb">export</span> <span class="nv">CORE_PEER_LOCALMSPID</span><span class="o">=</span><span class="s2">&quot;Org3MSP&quot;</span>
<span class="nb">export</span> <span class="nv">CORE_PEER_TLS_ROOTCERT_FILE</span><span class="o">=</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/organizations/peerOrganizations/org3.example.com/peers/peer0.org3.example.com/tls/ca.crt
<span class="nb">export</span> <span class="nv">CORE_PEER_MSPCONFIGPATH</span><span class="o">=</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/organizations/peerOrganizations/org3.example.com/users/Admin@org3.example.com/msp
<span class="nb">export</span> <span class="nv">CORE_PEER_ADDRESS</span><span class="o">=</span>peer0.org3.example.com:11051
</pre></div>
</div>
<p>Now let’s send a call to the ordering service asking for the genesis block of
<code class="docutils literal notranslate"><span class="pre">mychannel</span></code>. As a result of the successful channel update, the ordering service
will verify that Org3 can pull the genesis block and join the channel. If Org3 had not
been successfully appended to the channel config, the ordering service would
reject this request.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Again, you may find it useful to stream the ordering node’s logs
to reveal the sign/verify logic and policy checks.</p>
</div>
<p>Use the <code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span> <span class="pre">fetch</span></code> command to retrieve this block:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer channel fetch <span class="m">0</span> mychannel.block -o orderer.example.com:7050 -c <span class="nv">$CHANNEL_NAME</span> --tls --cafile <span class="nv">$ORDERER_CA</span>
</pre></div>
</div>
<p>Notice, that we are passing a <code class="docutils literal notranslate"><span class="pre">0</span></code> to indicate that we want the first block on
the channel’s ledger; the genesis block. If we simply passed the
<code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span> <span class="pre">fetch</span> <span class="pre">config</span></code> command, then we would have received block 3 – the
updated config with Org3 defined. However, we can’t begin our ledger with a
downstream block – we must start with block 0.</p>
<p>If successful, the command returned the genesis block to a file named <code class="docutils literal notranslate"><span class="pre">mychannel.block</span></code>.
We can now use this block to join the peer to the channel. Issue the
<code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span> <span class="pre">join</span></code> command and pass in the genesis block to join the Org3
peer to the channel:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer channel join -b mychannel.block
</pre></div>
</div>
</div>
<div class="section" id="configuring-leader-election">
<h2>Configuring Leader Election<a class="headerlink" href="#configuring-leader-election" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This section is included as a general reference for understanding
the leader election settings when adding organizations to a network
after the initial channel configuration has completed. This sample
defaults to dynamic leader election, which is set for all peers in the
network.</p>
</div>
<p>Newly joining peers are bootstrapped with the genesis block, which does not
contain information about the organization that is being added in the channel
configuration update. Therefore new peers are not able to utilize gossip as
they cannot verify blocks forwarded by other peers from their own organization
until they get the configuration transaction which added the organization to the
channel. Newly added peers must therefore have one of the following
configurations so that they receive blocks from the ordering service:</p>
<p>1. To utilize static leader mode, configure the peer to be an organization
leader:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CORE_PEER_GOSSIP_USELEADERELECTION</span><span class="o">=</span><span class="n">false</span>
<span class="n">CORE_PEER_GOSSIP_ORGLEADER</span><span class="o">=</span><span class="n">true</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This configuration must be the same for all new peers added to the
channel.</p>
</div>
<p>2. To utilize dynamic leader election, configure the peer to use leader
election:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CORE_PEER_GOSSIP_USELEADERELECTION</span><span class="o">=</span><span class="n">true</span>
<span class="n">CORE_PEER_GOSSIP_ORGLEADER</span><span class="o">=</span><span class="n">false</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Because peers of the newly added organization won’t be able to form
membership view, this option will be similar to the static
configuration, as each peer will start proclaiming itself to be a
leader. However, once they get updated with the configuration
transaction that adds the organization to the channel, there will be
only one active leader for the organization. Therefore, it is
recommended to leverage this option if you eventually want the
organization’s peers to utilize leader election.</p>
</div>
</div>
<div class="section" id="install-define-and-invoke-chaincode">
<span id="upgrade-and-invoke"></span><h2>Install, define, and invoke chaincode<a class="headerlink" href="#install-define-and-invoke-chaincode" title="Permalink to this headline">¶</a></h2>
<p>We can confirm that Org3 is a member of <code class="docutils literal notranslate"><span class="pre">mychannel</span></code> by installing and invoking
a chaincode on the channel. If the existing channel members have already committed
a chaincode definition to the channel, a new organization can start using the
chaincode by approving the chaincode definition.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>These instructions use the Fabric chaincode lifecycle introduced in
the v2.0 release. If you would like to use the previous lifecycle to
install and instantiate a chaincode, visit the v1.4 version of the
<a class="reference external" href="https://hyperledger-fabric.readthedocs.io/en/release-1.4/channel_update_tutorial.html">Adding an org to a channel tutorial</a>.</p>
</div>
<p>Before we install a chaincode as Org3, we can use the <code class="docutils literal notranslate"><span class="pre">./network.sh</span></code> script to
deploy the Fabcar chaincode on the channel. Open a new terminal outside the
Org3CLI container and navigate to the <code class="docutils literal notranslate"><span class="pre">test-network</span></code> directory. You can then use
use the <code class="docutils literal notranslate"><span class="pre">test-network</span></code> script to deploy the Fabcar chaincode:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> fabric-samples/test-network
./network.sh deployCC
</pre></div>
</div>
<p>The script will install the Fabcar chaincode on the Org1 and Org2 peers, approve
the chaincode definition for Org1 and Org2, and then commit the chaincode
definition to the channel. Once the chaincode definition has been committed to
the channel, the Fabcar chaincode is initialized and invoked to put initial data
on the ledger. The commands below assume that we are still using the channel
<code class="docutils literal notranslate"><span class="pre">mychannel</span></code>.</p>
<p>After the chaincode has been to deployed we can use the following steps to use
invoke Fabcar chaincode as Org3. These steps can be completed from the
<code class="docutils literal notranslate"><span class="pre">test-network</span></code> directory, without having to exec into Org3CLI container. Copy
and paste the following environment variables in your terminal in order to interact
with the network as the Org3 admin:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>/../bin:<span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>:<span class="nv">$PATH</span>
<span class="nb">export</span> <span class="nv">FABRIC_CFG_PATH</span><span class="o">=</span><span class="nv">$PWD</span>/../config/
<span class="nb">export</span> <span class="nv">CORE_PEER_TLS_ENABLED</span><span class="o">=</span><span class="nb">true</span>
<span class="nb">export</span> <span class="nv">CORE_PEER_LOCALMSPID</span><span class="o">=</span><span class="s2">&quot;Org3MSP&quot;</span>
<span class="nb">export</span> <span class="nv">CORE_PEER_TLS_ROOTCERT_FILE</span><span class="o">=</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>/organizations/peerOrganizations/org3.example.com/peers/peer0.org3.example.com/tls/ca.crt
<span class="nb">export</span> <span class="nv">CORE_PEER_MSPCONFIGPATH</span><span class="o">=</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>/organizations/peerOrganizations/org3.example.com/users/Admin@org3.example.com/msp
<span class="nb">export</span> <span class="nv">CORE_PEER_ADDRESS</span><span class="o">=</span>localhost:11051
</pre></div>
</div>
<p>The first step is to package the Fabcar chaincode:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer lifecycle chaincode package fabcar.tar.gz --path ../chaincode/fabcar/go/ --lang golang --label fabcar_1
</pre></div>
</div>
<p>This command will create a chaincode package named <code class="docutils literal notranslate"><span class="pre">fabcar.tar.gz</span></code>, which we can
install on the Org3 peer. Modify the command accordingly if the channel is running a
chaincode written in Java or Node.js. Issue the following command to install the
chaincode package <code class="docutils literal notranslate"><span class="pre">peer0.org3.example.com</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer lifecycle chaincode install fabcar.tar.gz
</pre></div>
</div>
<p>The next step is to approve the chaincode definition of Fabcar as Org3. Org3
needs to approve the same definition that Org1 and Org2 approved and committed
to the channel. In order to invoke the chaincode, Org3 needs to include the
package identifier in the chaincode definition. You can find the package
identifier by querying your peer:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer lifecycle chaincode queryinstalled
</pre></div>
</div>
<p>You should see output similar to the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Get installed chaincodes on peer:
Package ID: fabcar_1:25f28c212da84a8eca44d14cf12549d8f7b674a0d8288245561246fa90f7ab03, Label: fabcar_1
</pre></div>
</div>
<p>We are going to need the package ID in a future command, so lets go ahead and
save it as an environment variable. Paste the package ID returned by the
<code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">lifecycle</span> <span class="pre">chaincode</span> <span class="pre">queryinstalled</span></code> command into the command below. The
package ID may not be the same for all users, so you need to complete this step
using the package ID returned from your console.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CC_PACKAGE_ID</span><span class="o">=</span>fabcar_1:25f28c212da84a8eca44d14cf12549d8f7b674a0d8288245561246fa90f7ab03
</pre></div>
</div>
<p>Use the following command to approve a definition of the Fabcar chaincode
for Org3:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># use the --package-id flag to provide the package identifier</span>
<span class="c1"># use the --init-required flag to request the ``Init`` function be invoked to initialize the chaincode</span>
peer lifecycle chaincode approveformyorg -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --channelID mychannel --name fabcar --version <span class="m">1</span> --init-required --package-id <span class="nv">$CC_PACKAGE_ID</span> --sequence <span class="m">1</span> --tls <span class="nb">true</span> --cafile <span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem
</pre></div>
</div>
<p>You can use the <code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">lifecycle</span> <span class="pre">chaincode</span> <span class="pre">querycommitted</span></code> command to check if
the chaincode definition you have approved has already been committed to the
channel.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># use the --name flag to select the chaincode whose definition you want to query</span>
peer lifecycle chaincode querycommitted --channelID mychannel --name fabcar --cafile <span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem
</pre></div>
</div>
<p>A successful command will return information about the committed definition:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Committed chaincode definition <span class="k">for</span> chaincode <span class="s1">&#39;fabcar&#39;</span> on channel <span class="s1">&#39;mychannel&#39;</span>:
Version: <span class="m">1</span>, Sequence: <span class="m">1</span>, Endorsement Plugin: escc, Validation Plugin: vscc, Approvals: <span class="o">[</span>Org1MSP: true, Org2MSP: true, Org3MSP: true<span class="o">]</span>
</pre></div>
</div>
<p>Org3 can use the Fabcar chaincode after it approves the chaincode definition
that was committed to the channel. The chaincode definition uses the default endorsement
policy, which requires a majority of organizations on the channel endorse a transaction.
This implies that if an organization is added to or removed from the channel, the
endorsement policy will be updated automatically. We previously needed endorsements
from Org1 and Org2 (2 out of 2). Now we need endorsements from two organizations
out of Org1, Org2, and Org3 (2 out of 3).</p>
<p>You can query the chaincode to ensure that it has started on the Org3 peer. Note
that you may need to wait for the chaincode container to start.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer chaincode query -C mychannel -n fabcar -c <span class="s1">&#39;{&quot;Args&quot;:[&quot;queryAllCars&quot;]}&#39;</span>
</pre></div>
</div>
<p>You should see the initial list of cars that were added to the ledger as a
response.</p>
<p>Now, invoke the chaincode to add a new car to the ledger. In the command below,
we target a peer in Org1 and Org3 to collect a sufficient number of endorsements.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer chaincode invoke -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --tls <span class="nb">true</span> --cafile <span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C mychannel -n fabcar --peerAddresses localhost:7051 --tlsRootCertFiles <span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt --peerAddresses localhost:11051 --tlsRootCertFiles <span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>/organizations/peerOrganizations/org3.example.com/peers/peer0.org3.example.com/tls/ca.crt -c <span class="s1">&#39;{&quot;function&quot;:&quot;createCar&quot;,&quot;Args&quot;:[&quot;CAR11&quot;,&quot;Honda&quot;,&quot;Accord&quot;,&quot;Black&quot;,&quot;Tom&quot;]}&#39;</span>
</pre></div>
</div>
<p>We can query again to see the new car, “CAR11” on the our the ledger:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer chaincode query -C mychannel -n fabcar -c <span class="s1">&#39;{&quot;Args&quot;:[&quot;queryCar&quot;,&quot;CAR11&quot;]}&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>The channel configuration update process is indeed quite involved, but there is a
logical method to the various steps. The endgame is to form a delta transaction object
represented in protobuf binary format and then acquire the requisite number of admin
signatures such that the channel configuration update transaction fulfills the channel’s
modification policy.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">configtxlator</span></code> and <code class="docutils literal notranslate"><span class="pre">jq</span></code> tools, along with the <code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span></code>
commands, provide us with the functionality to accomplish this task.</p>
</div>
<div class="section" id="updating-the-channel-config-to-include-an-org3-anchor-peer-optional">
<h2>Updating the Channel Config to include an Org3 Anchor Peer (Optional)<a class="headerlink" href="#updating-the-channel-config-to-include-an-org3-anchor-peer-optional" title="Permalink to this headline">¶</a></h2>
<p>The Org3 peers were able to establish gossip connection to the Org1 and Org2
peers since Org1 and Org2 had anchor peers defined in the channel configuration.
Likewise newly added organizations like Org3 should also define their anchor peers
in the channel configuration so that any new peers from other organizations can
directly discover an Org3 peer. In this section, we will make a channel
configuration update to define an Org3 anchor peer. The process will be similar
to the previous configuration update, therefore we’ll go faster this time.</p>
<p>If you don’t have it open, exec back into the Org3CLI container:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker <span class="nb">exec</span> -it Org3cli bash
</pre></div>
</div>
<p>Export the $ORDERER_CA and $CHANNEL_NAME variables if they are not already set:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">ORDERER_CA</span><span class="o">=</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem
<span class="nb">export</span> <span class="nv">CHANNEL_NAME</span><span class="o">=</span>mychannel
</pre></div>
</div>
<p>As before, we will fetch the latest channel configuration to get started.
Inside the Org3CLI container, fetch the most recent config block for the channel,
using the <code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span> <span class="pre">fetch</span></code> command.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer channel fetch config config_block.pb -o orderer.example.com:7050 -c <span class="nv">$CHANNEL_NAME</span> --tls --cafile <span class="nv">$ORDERER_CA</span>
</pre></div>
</div>
<p>After fetching the config block we will want to convert it into JSON format. To do
this we will use the configtxlator tool, as done previously when adding Org3 to the
channel. When converting it we need to remove all the headers, metadata, and signatures
that are not required to update Org3 to include an anchor peer by using the jq
tool. This information will be reincorporated later before we proceed to update the
channel configuration.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator proto_decode --input config_block.pb --type common.Block <span class="p">|</span> jq .data.data<span class="o">[</span><span class="m">0</span><span class="o">]</span>.payload.data.config &gt; config.json
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">config.json</span></code> is the now trimmed JSON representing the latest channel configuration
that we will update.</p>
<p>Using the jq tool again, we will update the configuration JSON with the Org3 anchor peer we
want to add.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>jq <span class="s1">&#39;.channel_group.groups.Application.groups.Org3MSP.values += {&quot;AnchorPeers&quot;:{&quot;mod_policy&quot;: &quot;Admins&quot;,&quot;value&quot;:{&quot;anchor_peers&quot;: [{&quot;host&quot;: &quot;peer0.org3.example.com&quot;,&quot;port&quot;: 11051}]},&quot;version&quot;: &quot;0&quot;}}&#39;</span> config.json &gt; modified_anchor_config.json
</pre></div>
</div>
<p>We now have two JSON files, one for the current channel configuration,
<code class="docutils literal notranslate"><span class="pre">config.json</span></code>, and one for the desired channel configuration <code class="docutils literal notranslate"><span class="pre">modified_anchor_config.json</span></code>.
Next we convert each of these back into protobuf format and calculate the delta between the two.</p>
<p>Translate <code class="docutils literal notranslate"><span class="pre">config.json</span></code> back into protobuf format as <code class="docutils literal notranslate"><span class="pre">config.pb</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator proto_encode --input config.json --type common.Config --output config.pb
</pre></div>
</div>
<p>Translate the <code class="docutils literal notranslate"><span class="pre">modified_anchor_config.json</span></code> into protobuf format as <code class="docutils literal notranslate"><span class="pre">modified_anchor_config.pb</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator proto_encode --input modified_anchor_config.json --type common.Config --output modified_anchor_config.pb
</pre></div>
</div>
<p>Calculate the delta between the two protobuf formatted configurations.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator compute_update --channel_id <span class="nv">$CHANNEL_NAME</span> --original config.pb --updated modified_anchor_config.pb --output anchor_update.pb
</pre></div>
</div>
<p>Now that we have the desired update to the channel we must wrap it in an envelope
message so that it can be properly read. To do this we must first convert the protobuf
back into a JSON that can be wrapped.</p>
<p>We will use the configtxlator command again to convert <code class="docutils literal notranslate"><span class="pre">anchor_update.pb</span></code> into <code class="docutils literal notranslate"><span class="pre">anchor_update.json</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator proto_decode --input anchor_update.pb --type common.ConfigUpdate <span class="p">|</span> jq . &gt; anchor_update.json
</pre></div>
</div>
<p>Next we will wrap the update in an envelope message, restoring the previously
stripped away header, outputting it to <code class="docutils literal notranslate"><span class="pre">anchor_update_in_envelope.json</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s1">&#39;{&quot;payload&quot;:{&quot;header&quot;:{&quot;channel_header&quot;:{&quot;channel_id&quot;:&quot;&#39;</span><span class="nv">$CHANNEL_NAME</span><span class="s1">&#39;&quot;, &quot;type&quot;:2}},&quot;data&quot;:{&quot;config_update&quot;:&#39;</span><span class="k">$(</span>cat anchor_update.json<span class="k">)</span><span class="s1">&#39;}}}&#39;</span> <span class="p">|</span> jq . &gt; anchor_update_in_envelope.json
</pre></div>
</div>
<p>Now that we have reincorporated the envelope we need to convert it
to a protobuf so it can be properly signed and submitted to the orderer for the update.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>configtxlator proto_encode --input anchor_update_in_envelope.json --type common.Envelope --output anchor_update_in_envelope.pb
</pre></div>
</div>
<p>Now that the update has been properly formatted it is time to sign off and submit it. Since this
is only an update to Org3 we only need to have Org3 sign off on the update. Run the following
commands to make sure that we are operating as the Org3 admin:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># you can issue all of these commands at once</span>

<span class="nb">export</span> <span class="nv">CORE_PEER_LOCALMSPID</span><span class="o">=</span><span class="s2">&quot;Org3MSP&quot;</span>
<span class="nb">export</span> <span class="nv">CORE_PEER_TLS_ROOTCERT_FILE</span><span class="o">=</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/organizations/peerOrganizations/org3.example.com/peers/peer0.org3.example.com/tls/ca.crt
<span class="nb">export</span> <span class="nv">CORE_PEER_MSPCONFIGPATH</span><span class="o">=</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/organizations/peerOrganizations/org3.example.com/users/Admin@org3.example.com/msp
<span class="nb">export</span> <span class="nv">CORE_PEER_ADDRESS</span><span class="o">=</span>peer0.org3.example.com:11051
</pre></div>
</div>
<p>We can now just use the <code class="docutils literal notranslate"><span class="pre">peer</span> <span class="pre">channel</span> <span class="pre">update</span></code> command to sign the update as the
Org3 admin before submitting it to the orderer.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>peer channel update -f anchor_update_in_envelope.pb -c <span class="nv">$CHANNEL_NAME</span> -o orderer.example.com:7050 --tls --cafile <span class="nv">$ORDERER_CA</span>
</pre></div>
</div>
<p>The orderer receives the config update request and cuts a block with the updated configuration.
As peers receive the block, they will process the configuration updates.</p>
<p>Inspect the logs for one of the peers. While processing the configuration transaction from the new block,
you will see gossip re-establish connections using the new anchor peer for Org3. This is proof
that the configuration update has been successfully applied!</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker logs -f peer0.org1.example.com
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">2019</span>-06-12 <span class="m">17</span>:08:57.924 UTC <span class="o">[</span>gossip.gossip<span class="o">]</span> learnAnchorPeers -&gt; INFO 89a Learning about the configured anchor peers of Org1MSP <span class="k">for</span> channel mychannel : <span class="o">[{</span>peer0.org1.example.com <span class="m">7051</span><span class="o">}]</span>
<span class="m">2019</span>-06-12 <span class="m">17</span>:08:57.926 UTC <span class="o">[</span>gossip.gossip<span class="o">]</span> learnAnchorPeers -&gt; INFO 89b Learning about the configured anchor peers of Org2MSP <span class="k">for</span> channel mychannel : <span class="o">[{</span>peer0.org2.example.com <span class="m">9051</span><span class="o">}]</span>
<span class="m">2019</span>-06-12 <span class="m">17</span>:08:57.926 UTC <span class="o">[</span>gossip.gossip<span class="o">]</span> learnAnchorPeers -&gt; INFO 89c Learning about the configured anchor peers of Org3MSP <span class="k">for</span> channel mychannel : <span class="o">[{</span>peer0.org3.example.com <span class="m">11051</span><span class="o">}]</span>
</pre></div>
</div>
<p>Congratulations, you have now made two configuration updates — one to add Org3 to the channel,
and a second to define an anchor peer for Org3.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="config_update.html" class="btn btn-neutral float-right" title="&lt;no title&gt;" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="couchdb_tutorial.html" class="btn btn-neutral" title="Using CouchDB" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Hyperledger 2020.
    <br>
      <br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>
      <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
        <img alt="Creative Commons License" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>