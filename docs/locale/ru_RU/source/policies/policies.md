# Установленные правила

**Целевая аудитория**: архитекторы, разработчики приложений и смарт-контрактов, администраторы

В этом разделе:

* [Что такое установленные правила](#what-is-a-policy)
* [Зачем нужны установленные правила](#why-are-policies-needed)
* [Реализация установленных правил в Fabric](#how-are-policies-implemented-throughout-fabric) 
* [Домены установленных правил Fabric](#the-fabric-policy-domains) 
* [Как создавать установленные правила в Fabric](#how-do-you-write-a-policy-in-fabric)
* [Жизненный цикл чейнкода Fabric](#fabric-chaincode-lifecycle) 
* [Замена установленных правил](#overriding-policy-definitions) 

## Что такое установленные правила

На самом базовом уровне установленные правила — это набор правил, определяющих структуру принятия решений и достижения конкретных результатов. Например, для этой цели в правилах обычно описываются **кто** или **что**. Например, возможности доступа или права, которые участник имеет в отношении **актива**. В повседневной жизни страховые полисы используются для защиты ценных активов, таких как автомобили, недвижимость, здоровье, и т.д.

Например, при страховании определяются условия, лимиты и срок действия страховых выплат. Так, в страховом полисе, условия которого согласовываются между владельцем полиса и страховой компанией, определяются права и обязанности каждой стороны.

В то время как страховые полисы применяются для управления рисками, в Hyperledger Fabric правила являются механизмом управления инфраструктурой. Установленные правила Fabric описывают то, как участники приходят к соглашению о принятии или отклонении изменений в рамках сети, канала или смарт-контракта. Установленные правила согласовываются членами консорциума в время изначальной настройки сети, однако правила могут изменяться по мере развития сети. Например, они позволяют задать критерии для добавления или удаления участников из канала, описать способ формирования блоков или указать количество организаций, необходимых для одобрения смарт-контракта. Все эти операции описываются установленными правилами, которые определяет полномочия, необходимые для выполнения операции. Проще говоря, все действия в сети Fabric контролируются установленными правилами. 

## Зачем нужны установленные правила

Установленные правила — это один из элементов, отличающих платформу Hyperledger Fabric от других блокчейнов, таких как Ethereum или Bitcoin. В этих системах транзакции могут быть сгенерированы и подтверждены любым узлом сети. Управляющие сетью правила являются неизменными во времени и могут быть изменены только с использованием того же процесса, который управляет кодом. Поскольку Fabric является закрытой блокчейн-сетью, в которой информация о пользователях закладывается в инфраструктуре, эти пользователи имеют возможность принимать решения об организации управления сетью до ее запуска, а также во время работы.

Установленные правила позволяют участникам решать, какие организации могут получать доступ к сети Fabric или обновлять ее, а также предоставляют механизм, гарантирующий соблюдение принятых решений. Установленные правила содержат списки организаций, которые имеют доступ к определенным ресурсам, например, к пользователям или системному чейнкоду. В них также указывается количество организаций, требуемое для одобрения запроса на обновление ресурса, такого как канал или смарт-контракт. После создания правил, они позволяют проверить соответствие руководящих организаций сети и подписей, прикрепленных к транзакциям и запросам на одобрение.

## Реализация установленных правил в Fabric

Для разных уровней сети Fabric предусматриваются различные правила. Каждый домен установленных правил управляет различными аспектами работы сети.

![policy.policies](./FabricPolicyHierarchy-2.png) *Визуальное представление иерархии правил Fabric.* 

 ### Конфигурация системного канала

Каждая сеть начинается с **системного канала** службы упорядочения. Для работы службы упорядочения должен существовать ровно один такой канал. Этот канал необходимо создать первым в системе. Системный канал также включает организации, которые являются членами службы упорядочения (организации службы упорядочения), а также организации, которые находятся в сети для осуществления транзакций (организации консорциума).

Правила блоков конфигурации системного канала службы упорядочения управляют консенсусом, используемым службой упорядочения, и определяют принципы создания новых блоков. Системный канал также определяет членов консорциума, которым разрешено создавать новые каналы.

### Конфигурация системного канала

_Каналы_ приложений используются для обеспечения механизма закрытой связи между организациями в консорциуме.

Установленные правила канала приложения управляют возможностью добавления или удаления участников канала. Каналы приложений также определяют организации, которые должны одобрять чейнкод, прежде чем он будет определен и записан в канал согласно жизненного цикла чейнкода Fabric. При создании канала приложения, все параметры службы упорядочения наследуются этим каналом от соответствующего системного канала. Однако эти параметры (и управляющие ими правила) могут быть настроены отдельно для каждого канала.

### Списки контроля доступа (ACL)

Списки контроля доступа будут особенно полезны для сетевых администраторов Fabric. Эти списки позволяют настраивать доступ к ресурсам путем связывания этих ресурсов с существующими установленными правилами. Эти «ресурсы» могут быть функциями системного чейнкода (например, «GetBlockByNumber» в системном чейнкоде «qscc») или другими ресурсами (например, ресурсы с правами на получение событий блока). Списки ACL относятся к правилам, определенным в конфигурации канала приложения, и расширяют их для управления дополнительными ресурсами. Списки ACL по умолчанию для Fabric содержатся в файле `configtx.yaml` в разделе `Application: &ApplicationDefaults`, однако списки можно и нужно переопределять в рабочей среде. Список ресурсов, указанных в файле configtx.yaml, представляет собой полный набор всех внутренних ресурсов, определенных в настоящий момент в сети Fabric.

В этом файле списки ACL указываются в следующем формате: 

```
# Правила ACL для вызова чейнкода другим чейнкодом 
peer/ChaincodeToChaincode: /Channel/Application/Readers
```

Где `peer/ChaincodeToChaincode` представляет собой защищаемый ресурс, а под `/Channel/Application/Readers` подразумеваются правила, которые должны выполняться для подтверждения соответствующей транзакции.

Для более глубокого понимания списков контроля доступа читайте раздел [ACL](../access_control.html) Руководства по использованию.

### Установленные правила одобрения смарт-контрактов

Каждый смарт-контракт внутри пакета чейнкода имеет правила одобрения, которые определяют, сколько одноранговых узлов от различных участников канала должны выполнить и одобрить транзакцию по рассматриваемому смарт-контракту, чтобы транзакция считалась подтвержденной. Следовательно, в установленных правилах одобрения определяются организации (а точнее одноранговые узлы этих организаций), которые должны «одобрить» (то есть подтвердить) выполнение запроса.

 ### Правила обновления

Предусмотрен еще один тип правил, который имеет решающее значение в работе установленных правил в Fabric, и это — `правила обновления`. Правила обновления определяют группу лиц, необходимых для подписания (одобрения) любого _обновления_ конфигурации. Эти правила определяет способ обновления любых других правил. Таким образом, каждый элемент конфигурации канала включает ссылку на правила, которая регулирует изменение этого элемента. 

## Домены установленных правил Fabric

Хотя установленные правила Fabric являются гибкими и могут быть настроены для удовлетворения любых потребностей сети, структура правил естественным образом ведет к разделению на домены, управляемые либо организациями службы упорядочения, либо членами консорциума. На следующей схеме показано, как осуществляется контроль над доменами правил Fabric с помощью правил по умолчанию. 

![policy.policies](./FabricPolicyHierarchy-4.png) *Более подробное представление доменов установленных правил, которыми управляют организации службы упорядочения и организации консорциума.*

Реальная сеть Fabric может включать множество организаций с разными обязанностями. Домены позволяют расширить различные привилегии и роли организаций, позволяя основателям службы упорядочения устанавливать изначальные правила и членство в консорциуме. Они также позволяют организациям, которые присоединяются к консорциуму, создавать частные каналы приложений, управлять собственной бизнес-логикой и ограничивать доступ к размещаемым в сети данным.

Конфигурация системного канала и часть конфигурации каждого канала приложений позволяет организациям службы упорядочения контролировать, какие организации могут входить в состав консорциума, каким образом блоки доставляются в каналы, а также управлять механизмом консенсуса, используемым узлами службы упорядочения.

Члены консорциума могут создавать каналы с помощью изменения конфигурации системного канала. Каналы приложений и списки управления доступом — это механизмы, позволяющие организациям консорциума добавлять или удалять участников каналов, а также устанавливать ограничения доступа к данным и смарт-контрактам в канале.

* Как создавать установленные правила в Fabric

Для внесения изменений в сети Fabric, относящиеся к ресурсу правила описывают, **кому** необходимо одобрить это ресурс, а также необходимость явного подтверждения отдельными участниками, либо неявного подтверждения группой. В сфере страхования в качестве явного подтверждения может рассматриваться один член группы страховых агентов домовладельцев. А неявное подтверждение можно представить аналогичным одобрению большинства руководителей страховой группы домовладельцев. Такое подтверждение особенно удобно, так как члены этой группы могут со временем меняться, не требуя обновления правил. В Hyperledger Fabric явное подтверждение выражается в правилах с помощью синтаксиса `Signature`, а для неявного подтверждения используется синтаксис `ImplicitMeta`.

 ### Правила подписи

Правила подписи `Signature` определяют типы пользователей, которые должны подписаться для удовлетворения требований правил, например, `OR('Org1.peer', 'Org2.peer')`. Эти правила считаются наиболее универсальными, позволяя указывать чрезвычайно подробные условия, например, «Администратор организации A и двое других администраторов или 5 из 6 администраторов организации». Синтаксис поддерживает произвольные комбинации «И», «ИЛИ» и «Nиз». Например, правила можно легко выразить с помощью выражения `AND('Org1.member', 'Org2.member')`, которое означает, что для удовлетворения правил требуется подпись по крайней мере одного члена организации ORG1 и одного члена ORG2.

 ### Правила ImplicitMeta

Правила `ImplicitMeta` действительны только в контексте конфигурации канала, которая основана на многоуровневой иерархии правил в дереве конфигурации. Правила `ImplicitMeta` объединяют результаты правил глубже по иерархии дерева конфигурации, которые в конечном итоге определяются правилами подписи. Они являются «неявными» (`Implicit`), потому что образуются неявно на основе текущих организаций, указанных в конфигурации канала. Также они имеют суффикс «мета» (`Meta`), так как в ходе проверки этих правил не используются конкретные доверители провайдеров службы членства, а скорее другие правила глубже по иерархии дерева конфигурации.

На следующей схеме показана многоуровневая структура правил для канала приложения. Также показано, каким образом происходит разрешение правил `ImplicitMeta` для администраторов конфигурации канала под названием `/Channel/Admins` в случае выполнения правил с названием `Admins` глубже по иерархии дерева конфигурации, где каждый флажок означает, что условия правил ниже по иерархии были выполнены.

![policies.policies](./FabricPolicyHierarchy-6.png)

Как видно на схеме выше, в правилах `ImplicitMeta`, `Type = 3`, используется другой синтаксис,`"
```
`MAJORITY sub policy: Admins`
```
На схеме показано правило `Admins`, которое относится ко всем правилам `Admins` ниже по иерархии в дереве конфигурации. Можно создавать свои собственные подправила с произвольными названиями, а затем назначать их соответствующим организациям.

Как упоминалось выше, ключевым преимуществом правил `ImplicitMeta`, например, `MAJORITY Admins`, является то, что правила канала не нужно обновлять при добавлении в канал новой организации-администратора. Поэтому правила `ImplicitMeta` считаются более гибкими в случае изменения членов консорциума. Консорциум службы упорядочения может изменяться по мере добавления новых членов или ухода существующего члена при согласии членов консорциума с изменениями, однако это не требует обновления правил. Напомним, что правила `ImplicitMeta` в конечном итоге разрешают правила `Signature` ниже по иерархии дерева конфигурации, как показано на схеме.

Также возможно задавать неявные правила на уровне приложения для разных организаций (например, в канале) с требованием выполнить любые (`ANY`) из правил, все (`ALL`) или большинство правил (`MAJORITY`). Благодаря такому формату обеспечиваются более удобные, более реалистичные значения по умолчанию, позволяя каждой организации устанавливать собственные условия одобрения.

Для еще большей конкретизации и контроля следует добавить [`NodeOUs`](msp.html#organization-units) в определение соответствующей организации. Организационные подразделения (OU) определяются в файле конфигурации клиента удостоверяющего центра Fabric и могут быть связаны с идентификаторами при их создании. В сетях Fabric подразделения `NodeOU` предоставляют способ классификации идентификаторов согласно иерархии цифровых сертификатов. Например, организация c включенной опцией узлов организационных подразделений `NodeOU` может создать условие, требующее подпись однорангового узла для одобрения, тогда как без этой опции подпись для одобрения может быть поставлена любым участником.

## Пример правил конфигурации канала

Хорошим началом для изучения установленных правил является файл `configtx.yaml`, в котором определены правила канала. В файле `configtx.yaml` из примера сети Fabric присутствуют оба типа синтаксиса установленных правил. Изучим структуру этого файла на примере [fabric-samples/test-network](https://github.com/hyperledger/fabric-samples/blob/{BRANCH}/test-network/configtx/configtx.yaml).

Первый раздел файла определяет организацию сети. Внутри каждого определения организации находятся правила по умолчанию для этой организации с названиями «чтение» (`Readers`), «запись» (`Writers`), «администратор» (`Admins`) и «одобрение» (`Endorsement`). Правила могут иметь любые произвольные названия. Каждое правило имеет тип (`Type`), который описывает принцип работы политики (`Signature` или `ImplicitMeta`), а также непосредственно содержит правило (`Rule`).

В приведенном ниже примере сети показано определение организации ORG1 в системном канале, где правила имеют тип `Signature`, а правило подтверждения имеет вид `"OR ('Org1MSP.peer')"`. Это правило означает, что для подписи требуется одноранговый узел, который является членом `Org1MSP`. Именно эти правила подписи становятся подправилами, на которые указывают правила `ImplicitMeta`.  

<details>
  <summary>
    **Нажмите, чтобы увидеть пример организации, определенной с помощью правил подписи**
  <summary>

```
 - &Org1
        # DefaultOrg defines the organization which is used in the sampleconfig
        # of the fabric.git development environment
        Name: Org1MSP

        # ID to load the MSP definition as
        ID: Org1MSP

        MSPDir: crypto-config/peerOrganizations/org1.example.com/msp

        # Policies defines the set of policies at this level of the config tree
        # For organization policies, their canonical path is usually
        #   /Channel/<Application|Orderer>/<OrgName>/<PolicyName>
        Policies:
            Readers:
                Type: Signature
                Rule: "OR('Org1MSP.admin', 'Org1MSP.peer', 'Org1MSP.client')"
            Writers:
                Type: Signature
                Rule: "OR('Org1MSP.admin', 'Org1MSP.client')"
            Admins:
                Type: Signature
                Rule: "OR('Org1MSP.admin')"
            Endorsement:
                Type: Signature
                Rule: "OR('Org1MSP.peer')"
```
</details>

В следующем примере показан тип правил `ImplicitMeta`, используемый в разделе приложения `Application` в файле `configtx.yaml`. Этот набор правил находится в папке `/Channel/Application/`. В случае использования набора списков контроля доступа Fabric по умолчанию, эти правила определяют работу многих важных функций каналов приложений, например, субъектов, которые могут запрашивать реестр канала, вызывать чейнкод или обновлять конфигурацию канала. Эти правила указывают на подправила, определенные для каждой организации. Организация Org1, определенная в разделе выше, содержит подправила `Reader`, `Writer` и `Admin`, которые разрешаются соответствующими правилами `ImplicitMeta` `Reader`, `Writer` и `Admin`  в разделе `Application`. Поскольку в примере сети применяются правила по умолчанию, можно использовать пример организации ORG1 для запроса реестра канала, вызова чейнкода и утверждения обновлений канала для любого созданного пробного сетевого канала.

<details>
  <summary>
    **Нажмите, чтобы увидеть пример правил ImplicitMeta**
  <summary>
      
```
################################################################################
#
#   SECTION: Application
#
#   - This section defines the values to encode into a config transaction or
#   genesis block for application related parameters
#
################################################################################
Application: &ApplicationDefaults

    # Organizations is the list of orgs which are defined as participants on
    # the application side of the network
    Organizations:

    # Policies defines the set of policies at this level of the config tree
    # For Application policies, their canonical path is
    #   /Channel/Application/<PolicyName>
    Policies:
        Readers:
            Type: ImplicitMeta
            Rule: "ANY Readers"
        Writers:
            Type: ImplicitMeta
            Rule: "ANY Writers"
        Admins:
            Type: ImplicitMeta
            Rule: "MAJORITY Admins"
        LifecycleEndorsement:
            Type: ImplicitMeta
            Rule: "MAJORITY Endorsement"
        Endorsement:
            Type: ImplicitMeta
            Rule: "MAJORITY Endorsement"
```
</details>

## Жизненный цикл чейнкода Fabric

В версии Fabric 2.0 был обновлен жизненный цикл чейнкода, благодаря которому обеспечивается более демократичный процесс управления чейнкодом в сети. Новый процесс позволяет нескольким организациям согласовывать принципы действия чейнкода перед его использованием в канале. Такая возможность важна, поскольку именно сочетание нового процесса жизненного цикла и правил, определенных в ходе этого процесса, определяют безопасность в сети. Более подробная информация о потоке доступна в теоретическом разделе [Жизненный цикл чейнкода Fabric](../chaincode_lifecycle.html), однако в контексте этого раздела следует разобраться с тем, каким образом правила используются в этом потоке. Новый поток состоит из двух этапов, в пределех которых работают правила — при **одобрении** чейнкода членами организации, и при **записи** его в канале.

Раздел `Application` файла `configtx.yaml` включает правила одобрения по умолчанию для жизненного цикла чейнкода. В рабочей среде можно изменить это определение под собственный вариант использования.

```
################################################################################
#
#   SECTION: Application
#
#   - This section defines the values to encode into a config transaction or
#   genesis block for application related parameters
#
################################################################################
Application: &ApplicationDefaults

    # Organizations is the list of orgs which are defined as participants on
    # the application side of the network
    Organizations:

    # Policies defines the set of policies at this level of the config tree
    # For Application policies, their canonical path is
    #   /Channel/Application/<PolicyName>
    Policies:
        Readers:
            Type: ImplicitMeta
            Rule: "ANY Readers"
        Writers:
            Type: ImplicitMeta
            Rule: "ANY Writers"
        Admins:
            Type: ImplicitMeta
            Rule: "MAJORITY Admins"
        LifecycleEndorsement:
            Type: ImplicitMeta
            Rule: "MAJORITY Endorsement"
        Endorsement:
            Type: ImplicitMeta
            Rule: "MAJORITY Endorsement"
```

- Правило `LifecycleEndorsement` определяет, кому нужно _подтверждать определение чейнкода_.
- Правило `Endorsement` — это _правило по умолчанию для одобрения чейнкода_. Подробнее об этом ниже.

## Правила одобрения чейнкода 

Правила одобрения предусматриваются для процесса одобрения и записи **чейнкода** в канале с использованием жизненного цикла чейнкода Fabric (то есть единые установленные правила одобрения, которые охватывают все состояния, связанные с чейнкодом). Правила одобрения можно указать с помощью ссылки на правила одобрения, определенные в конфигурации канала, либо путем явного указания правил подписи.

Если правила одобрения не указываются явно для этапа подтверждения, то используются правила одобрения по умолчанию `"MAJORITY Endorsement"`, означающие, что большинство пиров от разных участников канала (организаций) должны выполнить и подтвердить транзакцию, связанную с чейнкодом, чтобы транзакция считалась подтвержденной.  Эти правила по умолчанию позволяют автоматически добавлять организации, которые присоединяются к каналу, в правила одобрения чейнкода. Если вы не хотите использовать правила одобрения по умолчанию, можно использовать формат правил подписи `Signature` для создания более сложных правил одобрения (например, требуя одобрения чейнкода одной организацией, а затем еще одной из организаций канала).

Правила подписи также позволяют включать «доверителей», которые представляют собой способ связывания идентификатора с ролью. Имея схожесть с идентификаторами пользователей или групп, доверители являются более универсальными, поскольку могут содержать большое количество свойств субъекта, например, организацию субъекта, организационное подразделение, роль или даже конкретные личные данные субъекта. В случае доверителей, эти свойства определяют их разрешения. Доверители имеют названия в виде «MSP.ROLE», где `MSP` представляет собой требуемый идентификатор провайдера службы членства (организации), а `ROLE` представляет одну из четырех принятых ролей: участник, администратор, клиент и одноранговый узел. Роль связывается с идентификатором при регистрации пользователя в удостоверяющем центре. Доступные в удостоверяющем центре Fabric роли можно настраивать.

Вот некоторые возможные примеры доверителей:
* 'Org0.Admin': администратор MSP организации Org0.
* 'Org1.Member': член MSP организации Org1.
* 'Org1.Client': клиент MSP организации Org1. 
* 'Org1.Peer': одноранговый узел MSP организации Org1.
* 'OrdererOrg.Orderer': узел службы упорядочения MSP организации OrdererOrg.

В некоторых случаях могут потребоваться другие правила одобрения для определенных состояний (другими словами, конкретных пар «ключ-значение») . Такое **одобрение на основе состояния** позволяет заменить правила одобрения по умолчанию на уровне чейнкода другими правилами для указанных ключей.

Более подробные сведения о том, как создавать правила одобрения, приведены в разделе [Правила одобрения](../endorsement-policy.html) Руководства по использованию.

**Примечание.** Правила работают по-разному в зависимости от версии Fabric.
- В версиях Fabric ранее 2.0 правила одобрения чейнкода могут быть обновлены во время создания экземпляра чейнкода или с помощью команд жизненного цикла чейнкода. Правила одобрения по умолчанию имеют форму «любой член организации в канале» в случае, если не указывается иное во время создания экземпляра чейнкода. Например, канал с организациями «Org1» и «Org2» будет иметь следующие правила одобрения по умолчанию: «OR(‘Org1.member’,‘Org2.member’)».
- Начиная с Fabric версии 2.0 был добавлен новый процесс жизненного цикла чейнкода, который позволяет нескольким организациям согласовывать особенности работы чейнкода перед его использованием в канале.  В новом процессе организации согласовывают определяющие чейнкод параметры — название, версию и правила одобрения чейнкода. 

## Изменение определений правил

Hyperledger Fabric включает правила по умолчанию, которые могут быть полезными при знакомстве, разработке и тестировании чейнкода. Однако эти правила можно полностью заменить в рабочей среде. Правила по умолчанию указываются в файле `configtx.yaml`. Правила конфигурации каналов могут быть дополнены любым количеством правил, помимо стандартных `Readers, Writers, Admins` в файле` configtx.yaml`. Каналы службы упорядочения и приложений могут быть изменены путем обновления конфигурации и замены правил по умолчанию в файле `configtx.yaml` для системного канала или любого другого канала.

Дополнительная информация приведена в разделе [Изменение конфигурации канала](../config_update.html#update-a-channel-configuration).